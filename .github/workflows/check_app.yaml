name: Check Black & Install

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create isolated working directory
        run: |
          PYTHON_VERSION="${{ matrix.python-version }}"
          WORKDIR="work-$PYTHON_VERSION"
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"

          # Копируем основные исполняемые файлы
          cp ../run.py ./
          cp ../dbpatch.py ./
          cp ../create_user.py ./
          cp ../backuper.py ./
          cp ../requirements.txt ./
          cp ../config_example.py config.py

          # Рекурсивно копируем директории
          cp -r ../app ./
          cp -r ../supervisor ./supervisor 2>/dev/null || echo "supervisor/ not found, skipping."

          # Проверка копирования
          if [ ! -f "run.py" ]; then
            echo "❌ Ошибка: run.py не скопирован!"
            exit 1
          fi
          if [ ! -d "app" ]; then
            echo "❌ Ошибка: директория app/ не скопирована!"
            exit 1
          fi
          echo "✅ Файлы успешно скопированы в $WORKDIR"

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-venv postgresql nginx openssl netcat-openbsd

      - name: Start PostgreSQL
        run: sudo systemctl start postgresql

      - name: Setup DB and run app in isolated env
        run: |
          PYTHON_VERSION="${{ matrix.python-version }}"
          WORKDIR="work-$PYTHON_VERSION"
          cd "$WORKDIR"

          # Создаём необходимые директории
          mkdir -p logs backups user_uploads certs

          # Создаём виртуальное окружение
          python -m venv venv
          source venv/bin/activate

          # Уникальные параметры
          export DB_NAME="nabs_db_py${PYTHON_VERSION//./}"
          export DB_USER="nabs_user_py${PYTHON_VERSION//./}"
          export DB_PASSWORD=$(openssl rand -base64 14)
          export APP_PORT=$((5000 + 10 * $(echo $PYTHON_VERSION | cut -d'.' -f2)))
          export FLASK_ENV=production
          export FLASK_DEBUG=0

          echo "[+] DB: $DB_NAME, User: $DB_USER, Port: $APP_PORT"

          # Создаём БД
          sudo -u postgres psql -c "DROP DATABASE IF EXISTS $DB_NAME;"
          sudo -u postgres psql -c "DROP USER IF EXISTS $DB_USER;"
          sudo -u postgres psql -c "CREATE DATABASE $DB_NAME;"
          sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

          # Устанавливаем зависимости
          pip install -r requirements.txt

          # Настраиваем config.py
          sed -i "s|DBPassword *= *\".*\"|DBPassword = \"$DB_PASSWORD\"|g" config.py

          # Применяем миграции
          python dbpatch.py || echo "Миграции применены или не требуются"

          # Запускаем сервер в фоне
          nohup python run.py > app.log 2>&1 &
          SERVER_PID=$!
          echo "✅ Сервер запущен, PID: $SERVER_PID"

          # Ждём запуска
          sleep 15

          # Проверяем, слушает ли порт
          if ! nc -z 127.0.0.1 $APP_PORT; then
            echo "❌ Сервер не запущен на порту $APP_PORT"
            tail -n 30 app.log
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          # Проверяем HTTP-ответ
          if ! curl -f -s http://127.0.0.1:$APP_PORT; then
            echo "❌ Сервер не отвечает на HTTP"
            tail -n 30 app.log
            kill $SERVER_PID
            exit 1
          fi

          echo "✅ Сервер успешно запущен и отвечает на порту $APP_PORT"

          # Успешно завершаем: останавливаем сервер
          echo "ℹ️ Останавливаем сервер..."
          kill $SERVER_PID
          sleep 3
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "⚠️ Принудительное завершение..."
            kill -9 $SERVER_PID
          fi
          echo "✅ Сервер остановлен. Тест пройден!"

      - name: Verify server response
        run: |
          PYTHON_VERSION="${{ matrix.python-version }}"
          APP_PORT=$((5000 + 10 * $(echo $PYTHON_VERSION | cut -d'.' -f2)))
          # Проверяем HTTP-ответ (ожидаем 200, 302 или 401 — в зависимости от авторизации)
          if curl -f -v http://127.0.0.1:$APP_PORT; then
            echo "✅ Сервер отвечает на HTTP-запросы"
          else
            echo "❌ Сервер не отвечает корректно"
            # Покажем логи, если запрос провалился
            WORKDIR="work-$PYTHON_VERSION"
            cat "$WORKDIR/app.log" | tail -n 50
            exit 1
          fi
