{% extends 'base.html' %} {% block title %}Config compare {{ ipaddress }}{% endblock %} {% block body %}
<script>
    // start diff script after page load
    $(document).ready(function () {
        //same as: $(function() {
        changeFunc();
    });
</script>
<script type="text/javascript" src="{{url_for('static', filename='js/diff_page.js')}}"></script>
<script type="text/javascript" src="{{url_for('static', filename='js/diff_table.js')}}"></script>
<script type="text/javascript" src="{{url_for('static', filename='js/difflib.js')}}"></script>
<link rel="stylesheet" href="{{url_for('static', filename='css/table.css')}}" />
<div class="container-fluid">
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">Configs: {{ device_environment["device_hostname"] }} ({{ device_environment["device_ip"] }})</button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div class="row">
                        <input type="hidden" id="contextSize" value="" />
                        <div class="col-sm">
                            <h3 id="previous_config_label">Previous config:</h3>
                            <div class="textarea-container">
                                <textarea class="form-control" id="baseText" name="previous_config" disabled></textarea>
                                <button class="btn btn-icon btn-sm" type="button" id="copy-button" onclick="copy('baseText', 'copy-button')" title="Copy to Clipboard">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="col-sm">
                            <h3>Last config: {{timestamp}}</h3>
                            <div class="textarea-container">
                                <textarea class="form-control" id="newText" disabled>{{ last_config }}</textarea>
                                <button class="btn btn-icon btn-sm" type="button" id="copy-new-button" onclick="copy('newText', 'copy-new-button')" title="Copy to Clipboard">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Copy to clipboard config function
        function copy(areaid, btnid) {
            let textarea = document.getElementById(areaid);
            let button = document.getElementById(btnid);
            textarea.disabled = false;
            textarea.select();
            document.execCommand("copy");
            // Highlight button
            textarea.disabled = true;

            button.classList.add("btn-outline-success");
            let buttonicon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">';
            buttonicon += '  <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>';
            buttonicon += "</svg>";
            button.innerHTML = buttonicon;
            // Revert button label after 3 seconds
            setTimeout(function () {
                button.classList.remove("btn-outline-success");
                let buttonoldicon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">';
                buttonoldicon += '<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>';
                buttonoldicon += '<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>';
                buttonoldicon += "</svg>";
                button.innerHTML = buttonoldicon;
            }, 3000);
        }
    </script>
    <br />
    <div class="row">
        <div class="col-sm">
            <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                <input class="btn-check text-center" type="radio" name="_viewtype" onclick="diffUsingJS(0);" checked="checked" id="sidebyside" />
                <label class="btn btn-outline-secondary text-center align-items-center" for="sidebyside">Side by Side</label>
                <input class="btn-check text-center" type="radio" onclick="diffUsingJS(1);" name="_viewtype" id="inline" />
                <label class="btn btn-outline-secondary text-center align-items-center" for="inline">Inline</label>
                <button class="btn btn-outline-secondary js--show-replace" id="date-btn" name="submit-btn" value="">Show changed</button>
                <script>
                    //Button show change context
                    $(".js--show-replace").on("click", function () {
                        var hide = $(".table td:not(.replace,.insert,.empty,.delete)").parents("tr");
                        hide.hide();
                        var show = $(" .replace, .insert, .empty, .delete").parents("tr");
                        show.prev().show();
                        show.prev().prev().show();
                        show.prev().prev().prev().show();
                        show.next().show();
                        show.next().next().show();
                        show.next().next().next().show();
                    });
                </script>
            </div>
        </div>
        <div class="col-sm">
            <div class="input-group has-validation">
                <select class="form-select" id="date" name="date" required="" onchange="changeFunc();">
                    {% if config_timestamp|length > 0: -%} {% for timestamp in config_timestamp -%}
                    <option value="{{timestamp}}">{{timestamp}}</option>
                    {% endfor -%} {% else: -%}
                    <option value="">Choose Date</option>
                    {% endif -%}
                </select>
                <button class="btn btn-danger" type="submit" id="date-btn" name="submit-btn" onclick="change_config();" value="" hidden>Restore</button>
            </div>
        </div>
    </div>
    <br />
    <div>
        <div>
            <input class="form-control" type="text" id="search-table" placeholder="Enter for search" onkeyup="tableSearch()" />
        </div>
        <div id="diffoutput"></div>
    </div>
</div>
<script>
    //function trim(str) {
    //    return str.toString().replace(/,|!/g, "");
    //}
    // Put ajax data in backand
    // var $j = jQuery.noConflict();
    function change_config() {
        document.getElementById("baseText").value = "";
        document.getElementById("search-table").value = "";
        var server_data = {
            device_id: "{{ device_environment["device_id"] }}",
            date: document.getElementsByName("date")[0].value,
        };
        // console.log(server_data);
        $.ajax({
            type: "POST",
            url: "/previous_config/",
            data: JSON.stringify(server_data),
            contentType: "application/json",
            dataType: "json",
            success: function (result) {
                // console.log(result);
                if (result["status"] != "none") {
                    // var changed = result["status"];
                    // changed = trim(changed);
                    document.getElementById("baseText").value = result["previous_config_file"];
                    document.getElementById("small_toast").innerHTML = document.getElementsByName("date")[0].value;
                    diffUsingJS();
                }
                if (result["status"] == "none") {
                    // console.log(result["status"]);
                    //show toasts param
                    var toastLiveExample = document.getElementById("liveToast");
                    var toast = new bootstrap.Toast(toastLiveExample);
                    toast.show();
                    //
                    // show toasts
                    document.getElementById("number-of-changes").innerHTML = result["status"];
                    document.getElementById("toasts_strong").innerHTML = "Config";
                }
            },
        });
    }
</script>
<script>
    //function trim2(str) {
    // return str.toString().replace("^n",'\n');
    //return str.toString().split("#");
    //}
</script>
<script>
    function diffUsingJS(viewType) {
        "use strict";
        var byId = function (id) {
                return document.getElementById(id);
            },
            base = difflib.stringAsLines(byId("baseText").value),
            newtxt = difflib.stringAsLines(byId("newText").value),
            sm = new difflib.SequenceMatcher(base, newtxt),
            opcodes = sm.get_opcodes(),
            diffoutputdiv = byId("diffoutput"),
            contextSize = byId("contextSize").value;

        diffoutputdiv.innerHTML = "";
        contextSize = contextSize || null;

        diffoutputdiv.appendChild(
            diffview.buildView({
                baseTextLines: base,
                newTextLines: newtxt,
                opcodes: opcodes,
                baseTextName: "Previous config",
                newTextName: "Last config",
                contextSize: contextSize,
                viewType: viewType,
            })
        );
    }
</script>
{% endblock %}
